<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Fit for the future? Environmental covariates and  random effects in stock assessment</title>
    <meta charset="utf-8" />
    <meta name="author" content="Sarah Gaichas, Micah Dean, Jon Deroba" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/tabwid/tabwid.css" rel="stylesheet" />
    <script src="libs/tabwid/tabwid.js"></script>
    <link rel="stylesheet" href="libs/EDAB_theme3_508_SOE_16by9.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: right, middle, my-title, title-slide

.title[
# Fit for the future?<br />Environmental covariates and <br />random effects in stock assessment
]
.subtitle[
## ICES ASC Session M: <br /> Controversial opinions in stock assessment and fisheries management<br /><br />17 September 2025
]
.author[
### Sarah Gaichas, Micah Dean, Jon Deroba
]

---

class: top, left





background-image: url("https://github.com/sgaichas/HSpresentations/raw/main/docs/images/AtlanticMapGOMandKlaipedacrop.png")
background-size: 1070px
background-position: bottom

# Environmental covariates and random effects

.pull-left-60[
## Controversial opinion: 

Random effects often improve model fit and solve model diagnostic problems, but may mask signals that could be explained by and projected with mechanistic processes.

Fitting the assessment model isn't our ultimate goal!  
Catch advice for future years is. 

]

.pull-right-40[
## Atlantic herring, *Clupea harengus*

&lt;img src="20250917_ICESASC_ecovRE_Gaichas_files/figure-html/herring-1.png" alt="Atlantic herring illustration, credit NOAA Fisheries, from https://www.fisheries.noaa.gov/s3/styles/original/s3/2022-08/640x427-Herring-Atlantic-NOAAFisheries.png" width="356" /&gt;
]


???
Both random effects and environmental covariates can help explain modeled population dynamics, but they may interact in unexpected ways. 

RE represent cumulative unknown drivers, which can be difficult to project into the future without understanding mechanisms, while environmental covariates represent possibly predictable but incomplete mechanistic drivers, whose influence may change over time.

RE solve a lot of diagnostic issues in models (e.g. retrospective patterns) and are considerably easier to implement than environmental covariates, which often require investment in research and development.


Considerable effort has been invested in evaluating potential environmental drivers of stock productivity, mortality, and/or availability in recent Northwest Atlantic stock assessments. Additional recent investment in regional ocean modeling is aimed at operational short term prediction of environmental conditions such as bottom temperature. Environmental drivers have been successfully included in stock assessments using the Woods Hole Assessment Model (WHAM), a state-space modeling framework. Here we review lessons learned and controversial opinions generated from attempts to include environmental recruitment covariates within a stock assessment for Atlantic herring. Environmental covariates were tailored to herring life history and implemented based on mechanistic hypotheses. Despite significant correlations with recruitment estimated from a prior (non-state-space) assessment model, none of the covariates were included in the final state-space model. We draw two main conclusions. First, even in a state of the art model there are limits on environmental covariate inclusion. For example, mechanistic linkages available for recruitment covariates dwindle if a stock recruit relationship cannot be estimated. Second, tradeoffs may exist between including mechanistic drivers as covariates and including random effects that account for variation from unidentified mechanisms. Herring recruitment covariates had much stronger explanatory power in the absence of numbers at age (NAA) random effects, but model fit was much better with NAA random effects. Given that some environmental covariates can be forecast, while some random effects cannot or it is not clear how, this presents a dilemma. Do we risk sacrificing short term prediction capability (needed by management) for assessment model fit (needed to get models accepted for use in management)? 


---
# What drives recruitment of Atlantic herring?

.pull-left[
![Atlantic herring spawning areas in the Gulf of Maine, Northweast Atlantic](https://github.com/sgaichas/HSpresentations/raw/main/docs/images/Micah_HerringSpawningMap.png)
]

.pull-right[
![Atlantic herring R/SSB and haddock predation index](https://github.com/sgaichas/HSpresentations/raw/main/docs/images/Micah_HerringRSSBhaddock.png)
Haddock egg predation looked promising based on the previous assessment and extensive data analysis

]

???

---
# New improved herring assessment, no covariate impact

.pull-left[
State space assessment has much better diagnostics, stability and the WHAM assessment framework designed to incorporate environmental covariates 

Yet haddock predation had negligible impact on recruitment



&lt;img src="20250917_ICESASC_ecovRE_Gaichas_files/figure-html/NAAonplots-1.png" width="49%" /&gt;&lt;img src="20250917_ICESASC_ecovRE_Gaichas_files/figure-html/NAAonplots-2.png" width="49%" /&gt;


]

.pull-right[
Why?

Limited ways to implement covariates: no stock recruit relationship

Best fit with numbers at age transition random effects: correlations among ages but not years 

![NAA RE implemented](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm205-test/plots_png/results/NAA_dev_tile.png)
]

???
New state space model developed with NAA RE, best fit with numbers at age transition correlations among ages but not years

Image of NAA RE pattern

![ecov fit with NAA RE](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm205-test/plots_png/diagnostics/NAA_4panel_stock_1_region_1_age_1.png)

Good model diagnostics

Including the covariate in the model: only one approach possible because stock recruit relationship not estimable

Model estimates recruitment as annual iid RE around an estimated fixed effect recruitment scaling parameter ("mean-ish" recruitment)

Model estimates a fit to covariate data, then estimates parameters of relationship with recruitment scaling parameter (lag-1-linear)

Image of fit to haddock predation index covariate


---
# Strong covariate effect, fit poorer without NAA RE

.pull-left[
An experiment fitting the model without NAA RE on ages 2+ and with the environmental covariate resulted in poorer model fit but a much stronger covariate effect; and a different recruitment signal

&lt;img src="20250917_ICESASC_ecovRE_Gaichas_files/figure-html/NAAoffplots-1.png" width="49%" /&gt;&lt;img src="20250917_ICESASC_ecovRE_Gaichas_files/figure-html/NAAoffplots-2.png" width="49%" /&gt;

]

.pull-right[

&lt;div class="tabwid"&gt;&lt;style&gt;.cl-63d53f00{}.cl-63d246b0{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-63d38a3e{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-63d38a48{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-63d39664{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-63d39665{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-63d3966e{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-63d3966f{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-63d39670{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-63d39678{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}&lt;/style&gt;&lt;table data-quarto-disable-processing='true' class='cl-63d53f00'&gt;&lt;thead&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;th class="cl-63d39664"&gt;&lt;p class="cl-63d38a3e"&gt;&lt;span class="cl-63d246b0"&gt;Model&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th class="cl-63d39665"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;conv&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th class="cl-63d39665"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;pdHess&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th class="cl-63d39665"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;NLL&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th class="cl-63d39665"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;dAIC&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th class="cl-63d39665"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;AIC&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-63d3966e"&gt;&lt;p class="cl-63d38a3e"&gt;&lt;span class="cl-63d246b0"&gt;NAAon_ecovoff&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-1,757.763&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;0.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-3,255.5&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-63d3966e"&gt;&lt;p class="cl-63d38a3e"&gt;&lt;span class="cl-63d246b0"&gt;NAAon_ecovon&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-1,758.735&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;0.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-3,255.5&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-63d3966e"&gt;&lt;p class="cl-63d38a3e"&gt;&lt;span class="cl-63d246b0"&gt;NAAoff_ecovon&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-1,688.659&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;136.2&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d3966f"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-3,119.3&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-63d39670"&gt;&lt;p class="cl-63d38a3e"&gt;&lt;span class="cl-63d246b0"&gt;NAAoff_ecovoff&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d39678"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d39678"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;TRUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d39678"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-1,679.479&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d39678"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;152.5&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-63d39678"&gt;&lt;p class="cl-63d38a48"&gt;&lt;span class="cl-63d246b0"&gt;-3,103.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;

![NAA RE off](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm207-ecovon/plots_png/results/NAA_dev_tile.png)


]

???
![ecov fit without NAA RE](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm207-ecovon/plots_png/diagnostics/NAA_4panel_stock_1_region_1_age_1.png)

And a different recruitment time series? NAA RE on ages soaking up some uncertainty that could be explained mechanistically

Image comparing recruitment deviations with and without NAA RE and impact of haddock predation index 

Need methods to address multiple covariates: larval optimal temperature duration similar results to haddock predation

---
#  Perception of the stock changes 

.pull-left[

![:img with NAA no ecov, 50%](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm204-ecovoff/plots_png/results/SSB_Rec_time_stock_1.png)![:img no NAA no ecov, 50%](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm206-ecovoff/plots_png/results/SSB_Rec_time_stock_1.png)
![:img with NAA and ecov, 50%](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm205-test/plots_png/results/SSB_Rec_time_stock_1.png)![:img no NAA and ecov, 50%](https://github.com/sgaichas/whamtest-covariates/raw/main/WHAMfits/mm207-ecovon/plots_png/results/SSB_Rec_time_stock_1.png)

]

.pull-right[

![modcompare all](https://github.com/sgaichas/whamtest-covariates/raw/main/compare_png/compare_rel_status_kobe.png)

Different assumptions affect reference point calculations

]



---
.pull-left[
# Discussion

RE interactions with covariates in state space assessment models needs more investigation. We dont have a recruitment index in this model, that data might help.

A lot of effort and review goes into identifying the model that best fits historical data, then we do projections separately with a single best fit model, but projections are what's used to set catch advice in fishery management.

Do we risk sacrificing short term prediction capability (needed by management) for assessment model fit (needed to get models accepted for use in management)? 

Past performance does not guarantee future returns!
]

.pull-right[
&lt;img src="20250917_ICESASC_ecovRE_Gaichas_files/figure-html/unnamed-chunk-3-1.png" width="504" /&gt;

# Thoughts? Thank you!
]


.footnote[
Slides available at https://sgaichas.github.io/HSpresentations  
Contact: &lt;sgaichas@hydrascientificllc.com&gt;
]

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="libs/macros.js"></script>
<script>var slideshow = remark.create({
  "ratio": "16:9",
  "highlightStyle": "githubp",
  "highlightLines": true,
  "countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
